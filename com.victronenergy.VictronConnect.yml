id: com.victronenergy.VictronConnect
runtime: org.kde.Platform
version: 6.11
sdk: org.kde.Sdk
runtime-version: '6.5'
#command: VictronConnect
only-arches:
  - x86_64
modules:
  - krb5.json
  - name: VictronConnectExtract
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
    sources:
      - type: extra-data 
        url: https://www.victronenergy.com/upload/software/VictronConnect-x86_64-v6.11.AppImage
        filename: VictronConnect.AppImage
        sha256: 1bdbe636abc02506ed641e763962d0da08788d1f372792b11790f6286b50726c
        size: 107865280
      - type: script
        dest-filename: apply_extra
        commands:
          - chmod a+x VictronConnect.AppImage
          - $(pwd)/VictronConnect.AppImage --appimage-extract
          - mv squashfs-root/VictronConnect.desktop squashfs-root/VictronConnect.png .
          - sed -i 's,Exec={EXEC},Exec=/usr/bin/flatpak run '${FLATPAK_ID}' %u,' VictronConnect.desktop 
          - sed -i 's,Icon=VictronConnect,Icon='${FLATPAK_ID}',' VictronConnect.desktop
          - install -Dm644 VictronConnect.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
          - install -Dm644 VictronConnect.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
          - mv squashfs-root/bin/* ${FLATPAK_DEST}/bin
          - mv squashfs-root/lib/* ${FLATPAK_DEST}/lib
          - mv squashfs-root/plugins ${FLATPAK_DEST}
          - mv squashfs-root/qml ${FLATPAK_DEST}
cleanup:
  - /squashfs-root
  - /include
  - /sbin
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  #Bluetooth
  - --system-talk-name=org.bluez
  - --allow=bluetooth

